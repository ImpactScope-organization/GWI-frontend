name: Build Docker image and push to GHCR, staging deploy to Dokploy

on:
  push:
    branches: ['develop']

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          build-args: |
            BUILD_ENV=development
            BUILD_API_HOST=https://gwi-api-staging.impactscope.io
            BUILD_PAYMENT_URL=https://buy.stripe.com/test_dRm4gy5ZpaYWcEhdAL5EY01
          push: true
          tags: |
            ghcr.io/impactscope-organization/gwi-frontend:latest-develop
          platforms: linux/amd64

      - name: Trigger Dokploy Deployment
        run: |
          echo "Triggering Dokploy deploy for app ${{ secrets.DOKPLOY_APPLICATION_ID }}..."
          curl -X POST \
            "${{ secrets.DOKPLOY_URL }}/api/application.deploy" \
            -H "accept: application/json" \
            -H "x-api-key: ${{ secrets.DOKPLOY_AUTH_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"applicationId\": \"${{ secrets.DOKPLOY_STAGING_APPLICATION_ID }}\"}"
